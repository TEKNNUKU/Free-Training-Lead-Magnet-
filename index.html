<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Build a Business That Sells for You</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{background:#101010;color:white;font-family:sans-serif;padding:20px}
.container{max-width:700px;margin:auto}
input{width:100%;padding:12px;margin-top:10px;border-radius:6px}
button{width:100%;padding:12px;margin-top:12px;background:gold;border:none;font-size:18px;font-weight:bold;border-radius:8px}
.success{color:#00ffae}
.error{color:#ff7070}
small{opacity:.7}
#videoSection{display:none;margin-top:20px}
#ctaOverlay{
  display:none;background:#000000e6;position:fixed;bottom:0;left:0;right:0;
  padding:16px;text-align:center;z-index:999
}
#ctaOverlay button{background:#25ff00}
</style>
</head>

<body>

<div class="container">
<h1>Build a Business That Sells for You</h1>
<p>Stop chasing customers.<br>Learn how to build digital systems that generate income automatically.</p>

<h3>Enter your details to unlock the training:</h3>

<form id="emailForm">
  <input type="email" id="email" placeholder="Your email address" required>
  <input type="tel" id="phone" placeholder="WhatsApp phone (+234...)" required>
  <button type="submit">Unlock Training</button>
  <p id="message"></p>
  <small>Your details are safe and used only for training follow-ups.</small>
</form>

<!-- VIDEO -->
<div id="videoSection">
<hr>
<video id="trainingVideo" width="100%" controls playsinline>
 <source src="https://pink-quiet-wolf-922.mypinata.cloud/ipfs/bafybeia4k6ubvkqwjyakoidtgm72yohkuzk6t464bz54y3yfxp3qzlvawa" type="video/mp4">
</video>
<p id="progressText"></p>
</div>
</div>

<!-- CTA -->
<div id="ctaOverlay">
<p><b>ðŸ”¥ Ready to go from idea to income?</b></p>
<p>Continue your journey inside the P2P Masterclass.</p>
<button onclick="goToMasterclass()">Join Masterclass Now</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, addDoc,
  collection, query,
  where, getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
 apiKey:"AIzaSyAUYkQ5wA3ncNqNvCkJFfqLkrLwolx632k",
 authDomain:"gated-video-landing-page.firebaseapp.com",
 projectId:"gated-video-landing-page",
 storageBucket:"gated-video-landing-page.firebasestorage.app",
 messagingSenderId:"942723264796",
 appId:"1:942723264796:web:95f20f94f88af0147d8ad9"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* DOM */
const form = document.getElementById("emailForm");
const email = document.getElementById("email");
const phone = document.getElementById("phone");
const msg = document.getElementById("message");
const video = document.getElementById("trainingVideo");
const box = document.getElementById("videoSection");
const prog = document.getElementById("progressText");
const overlay = document.getElementById("ctaOverlay");

/* VALIDATION */
const emailOK = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
const phoneOK = /^\+?[0-9]{10,15}$/;

/* FORM */
form.onsubmit = async (e)=>{
 e.preventDefault();

 const eVal = email.value.trim();
 const pVal = phone.value.trim();

 if(!emailOK.test(eVal)){
  msg.textContent="âŒ Enter a valid email";
  msg.className="error";
  return;
 }

 if(!phoneOK.test(pVal)){
  msg.textContent="âŒ Enter valid WhatsApp number";
  msg.className="error";
  return;
 }

 try{

  // DUP CHECK
  const q = query(collection(db,"leads"),where("email","==",eVal));
  const snap = await getDocs(q);
  if(!snap.empty){
   msg.textContent="âš ï¸ This email already registered.";
   msg.className="error";
   return;
  }

  // SAVE âœ…
  await addDoc(collection(db,"leads"),{
    email:eVal,
    phone:pVal,
    source:"Build A Business Training",
    createdAt:serverTimestamp()
  });

  // SHOW SUCCESS âœ…
  msg.textContent="âœ… Access unlocked. Enjoy the training.";
  msg.className="success";

  localStorage.setItem("viewerEmail", eVal);
  form.style.display="none";
  box.style.display="block";
  video.load();

  // SEND TELEGRAM (NON-BLOCKING)
  sendTelegramAlert(eVal, pVal);

 }catch(err){
  console.error(err);
  msg.textContent="âŒ Could not save your details.";
  msg.className="error";
 }

}

/* RESUME */
const t = localStorage.getItem("videoTime");
if(t) video.currentTime = parseFloat(t);

/* TRACKING */
video.addEventListener("timeupdate",()=>{
 localStorage.setItem("videoTime", video.currentTime);
 const pct = Math.floor(video.currentTime/video.duration*100||0);
 prog.textContent = `Watched ${pct}%`;
 if(pct>=80) overlay.style.display="block";
});

/* END => REDIRECT */
video.addEventListener("ended",()=>{
 localStorage.removeItem("videoTime");
 window.location.href="https://P2P.teknnuku.xyz";
});

window.goToMasterclass = ()=>{
 window.location.href="https://P2P.teknnuku.xyz";
};

/* TELEGRAM â€“ SAFE BG CALL */
async function sendTelegramAlert(email, phone){
 fetch("/api/telegram",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({email,phone})
 }).catch(()=>{});
}

</script>
</body>
</html>
